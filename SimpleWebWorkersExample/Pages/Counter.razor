@page "/"
@using SpawnDev.BlazorJS.WebWorkers

<PageTitle>WebWorker Example</PageTitle>

<h1>WebWorker Example</h1>

<p role="status">Current count: @currentCount</p>

<p>This WebWorker example will call the method 'CancellableMethod()' in a web worker which will simply loop for 60 seconds or until cancelled using a cancellation token via a button press.</p>
<p>The CancellableMethod method running in the web worker will report its progress back to the caller via an Action progress callback.</p>

<button disabled="@(cancellationTokenSource != null)" class="btn btn-primary" @onclick="IncrementCount">Start backgound Task</button>
<button disabled="@(cancellationTokenSource == null || cancellationTokenSource.IsCancellationRequested)" class="btn btn-primary" @onclick="CancelBackgroundTask">Cancel backgound Task</button>

@code {

    [Inject]
    WebWorkerService WebWorkerService { get; set; } = default!;
    CancellationTokenSource? cancellationTokenSource = null;
    private int currentCount = 0;

    void CancelBackgroundTask()
    {
        cancellationTokenSource?.Cancel();
    }
    private async Task IncrementCount()
    {
        cancellationTokenSource = new CancellationTokenSource();
        var maxRunTimeMS = 60000;
        var token = cancellationTokenSource.Token;
        StateHasChanged();
        await WebWorkerService.TaskPool.Run(() => CancellableMethod(maxRunTimeMS, ProgressCallbackTask, token));
        cancellationTokenSource?.Dispose();
        cancellationTokenSource = null;
    }
    /// <summary>
    /// This method will be called by the
    /// </summary>
    /// <param name="i"></param>
    void ProgressCallbackTask(int i)
    {
        currentCount = i;
        StateHasChanged();
    }
    /// <summary>
    /// This method will run in a web worker
    /// </summary>
    /// <param name="maxRunTimeMS"></param>
    /// <param name="progressCallback"></param>
    /// <param name="token"></param>
    /// <returns></returns>
    private static async Task<bool> CancellableMethod(double maxRunTimeMS, Action<int> progressCallback, CancellationToken token)
    {
        var startTime = DateTime.Now;
        var maxRunTime = TimeSpan.FromMilliseconds(maxRunTimeMS);
        var i = 0;
        while (DateTime.Now - startTime < maxRunTime)
        {
            i++;
            progressCallback(i);
            // do some work ...
            // check if cancelled using IsCancellationRequestedAsync extension method
            // internally calls Task.Delay(1) to allow event handlers time to receive a cancel message
            if (await token.IsCancellationRequestedAsync()) return true;
        }
        return false;
    }
}
